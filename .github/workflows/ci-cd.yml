name: CI / CD Pipeline

on:
  push:
    branches:
      - '**' # Запускати на push у будь-яку гілку
  pull_request:
    branches:
      - main # Запускати на Pull Request в гілку main

env:
  MAVEN_OPTS: -Xmx1024m

jobs:
  validate:
    name: 1. Validate Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          
      - name: Run Maven validate
        run: mvn -B validate

  unit-tests:
    name: 2. Run Unit Tests & Collect Reports
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      # Виправлення: Очищення перед тестуванням для уникнення проблем з кешем компілятора
      - name: Clean previous build
        run: mvn clean
        
      - name: Execute Unit Tests
        # Пропускаємо інтеграційні тести (ITs)
        run: mvn -B -DskipITs=true test
        
      - name: Upload Surefire Reports
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: target/surefire-reports

  package:
    name: 3. Package Application
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      # ДОДАНО: Чистимо перед пакуванням, щоб уникнути потенційних проблем з метаданими
      - name: Clean previous build
        run: mvn clean
        
      - name: Create JAR package
        # Пропускаємо всі тести при пакуванні, оскільки вони вже виконані
        run: mvn -B -DskipTests package
        
      - name: Upload JAR Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: target/*.jar

  integration-tests:
    name: 4. Run Integration Tests (with Testcontainers)
    runs-on: ubuntu-latest
    needs: package
    services:
      # Налаштування Docker-in-Docker для Testcontainers
      docker:
        image: docker:24-dind
        # Виправлення: 'privileged: true' видалено, залишено лише в options
        options: "--privileged --name docker"
        ports:
          - 2375:2375
    env:
      DOCKER_HOST: tcp://localhost:2375
      DOCKER_TLS_CERTDIR: "" # Вимкнення TLS для D-I-D
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for Docker service
        run: for i in $(seq 1 30); do docker version && break || sleep 1; done

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # Виконання інтеграційних тестів та збір JaCoCo
      - name: Execute Failsafe tests and JaCoCo report
        run: mvn -B -DskipTests=false -DskipITs=false verify

      # Завантаження звітів інтеграційних тестів
      - name: Upload Failsafe Reports
        uses: actions/upload-artifact@v4
        with:
          name: failsafe-reports
          path: target/failsafe-reports

      # Завантаження звіту покриття коду (JaCoCo)
      - name: Upload JaCoCo Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-site
          path: target/site/jacoco

  deploy:
    name: 5. Deploy to remote server
    runs-on: ubuntu-latest
    # Залежить від успішного пакування та інтеграційних тестів
    needs: [package, integration-tests]
    # Виконувати деплой лише, якщо зміни потрапили в гілку main
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Завантаження JAR-файлу, створеного на етапі 'package'
      - name: Download JAR Artifact
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: ./artifact

      # Підготовка SSH-середовища: автентифікація за приватним ключем
      - name: Prepare SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # Додавання хоста до known_hosts для запобігання запиту "Are you sure..."
          ssh-keyscan -H "${{ secrets.DEPLOY_HOST }}" >> ~/.ssh/known_hosts

      # Встановлення необхідних утиліт для SSH/SCP
      - name: Install dependencies (openssh-client, rsync)
        run: sudo apt-get update && sudo apt-get install -y openssh-client rsync

      # Завантаження JAR-файлу на сервер
      - name: Upload JAR to server
        run: scp -o StrictHostKeyChecking=no artifact/*.jar ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_PATH }}

      # Перезапуск сервісу на сервері
      - name: Restart service
        run: ssh -o StrictHostKeyChecking=no ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
          "sudo mv ${{ secrets.DEPLOY_PATH }}/*.jar /opt/java/webapps/library-app.jar && sudo systemctl restart library-app.service"
