name: CI / CD Pipeline

on:
push:
branches:
- '**'
pull_request:
branches:
- main

env:
MAVEN_OPTS: -Xmx1024m

jobs:
validate:
name: 1. Validate Code
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@v4
- uses: actions/setup-java@v4
with:
distribution: 'temurin'
java-version: '17'
- run: mvn -B validate

unit-tests:
name: 2. Run Unit Tests & Collect Reports
runs-on: ubuntu-latest
needs: validate
steps:
- uses: actions/checkout@v4
- uses: actions/setup-java@v4
with:
distribution: 'temurin'
java-version: '17'
- run: mvn clean
- run: mvn -B -DskipITs=true test

  - uses: actions/upload-artifact@v4
    with:
      name: surefire-reports
      path: target/surefire-reports


package:
name: 3. Package Application
runs-on: ubuntu-latest
needs: unit-tests
steps:
- uses: actions/checkout@v4
- uses: actions/setup-java@v4
with:
distribution: 'temurin'
java-version: '17'
- run: mvn clean
- run: mvn -B -DskipTests package

  - uses: actions/upload-artifact@v4
    with:
      name: app-jar
      path: target/*.jar


integration-tests:
name: 4. Run Integration Tests (with Testcontainers)
runs-on: ubuntu-latest
needs: package
services:
docker:
image: docker:24-dind
options: "--privileged --name docker"
ports:
- 2375:2375
env:
DOCKER_HOST: tcp://localhost:2375
DOCKER_TLS_CERTDIR: ""
steps:
- uses: actions/checkout@v4

  - name: Wait for Docker
    run: for i in $(seq 1 30); do docker version && break || sleep 1; done

  - uses: actions/setup-java@v4
    with:
      distribution: 'temurin'
      java-version: '17'

  - run: mvn clean
  - name: Failsafe tests and JaCoCo report
    run: mvn -B -DskipTests=false -DskipITs=false verify

  - uses: actions/upload-artifact@v4
    with:
      name: failsafe-reports
      path: target/failsafe-reports

  - uses: actions/upload-artifact@v4
    with:
      name: jacoco-report
      path: target/site/jacoco


coverage:
name: 5. Code Coverage Report
runs-on: ubuntu-latest
needs: integration-tests
steps:
- uses: actions/checkout@v4
- uses: actions/download-artifact@v4
with:
name: jacoco-report
path: jacoco-site

  - name: Dummy Coverage Check
    run: echo "JaCoCo report artifact downloaded successfully."


deploy:
name: 6. Deploy to server
runs-on: ubuntu-latest
needs: [package, integration-tests, coverage]
if: github.ref == 'refs/heads/main'
steps:
- uses: actions/checkout@v4

  - uses: actions/download-artifact@v4
    with:
      name: app-jar
      path: ./artifact

  - name: Install SSH + Rsync
    run: |
      sudo apt-get update || true
      sudo apt-get install -y --no-install-recommends openssh-client rsync || true
  
  - name: Prepare SSH
    run: |
      mkdir -p ~/.ssh
      echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
      chmod 600 ~/.ssh/id_rsa
      ssh-keyscan -H "${{ secrets.DEPLOY_HOST }}" >> ~/.ssh/known_hosts
      
  - name: Upload to server
    run: |
      scp -o StrictHostKeyChecking=no artifact/*.jar \
      ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_PATH }}
      
  - name: Restart service
    run: |
      ssh -o StrictHostKeyChecking=no ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
      "sudo mv ${{ secrets.DEPLOY_PATH }}/*.jar /opt/java/webapps/library-app.jar && sudo systemctl restart library-app.service"
