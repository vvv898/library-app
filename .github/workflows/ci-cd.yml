# .github/workflows/ci-cd.yml
name: CI / CD Pipeline

on:
  push:
    branches: [ '**' ]
  pull_request:
    branches: [ main ]

env:
  MAVEN_OPTS: -Xmx2048m -XX:ReservedCodeCacheSize=512m

jobs:
  validate:
    name: "1. Validate"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven
      - run: mvn -B validate

  unit-tests:
    name: "2. Unit Tests"
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven
      - name: Run Unit Tests
        run: mvn -B clean test -DskipITs=true    # clean обов'язково!
      - name: Upload Surefire Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: target/surefire-reports/
          if-no-files-found: ignore

  package:
    name: "3. Package JAR"
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven
      - name: Build JAR
        run: mvn -B clean package -DskipTests
      - uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: target/*.jar

  integration-tests:
    name: "4. Integration Tests (Testcontainers)"
    runs-on: ubuntu-latest
    needs: package
    timeout-minutes: 30
    services:
      docker:
        image: docker:24-dind
        options: --privileged --storage-opt size=50G
        ports:
          - 2375:2375
    env:
      DOCKER_HOST: tcp://localhost:2375
      DOCKER_TLS_CERTDIR: ""
      TESTCONTAINERS_REUSE_ENABLE: "true"
    steps:
      - uses: actions/checkout@v4

      - name: Start Docker properly
        run: |
          dockerd --host=tcp://0.0.0.0:2375 --storage-driver=overlay2 &
          timeout 90 bash -c 'until docker info; do sleep 3; done'

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven

      - name: Run ALL tests + JaCoCo (unit + integration)
        run: |
          mvn -B clean verify -Pcoverage   # ключовий момент!

      - name: Force JaCoCo Report Generation
        run: |
          mvn -B jacoco:report || true
          ls -la target/site/jacoco/ || echo "No JaCoCo yet"
          test -f target/site/jacoco/index.html && echo "JaCoCo OK" || (echo "JaCoCo failed" && exit 1)

      - name: Upload JaCoCo Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-site
          path: target/site/jacoco/
          if-no-files-found: error

      - name: Upload Failsafe Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: failsafe-reports
          path: target/failsafe-reports/
          if-no-files-found: ignore

  coverage:
    name: "5. Code Coverage"
    needs: integration-tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: jacoco-site
          path: public/jacoco
      - name: Show link
        run: |
          echo "JaCoCo Report → https://htmlpreview.github.io/?https://github.com/${{ github.repository }}/blob/${{ github.sha }}/public/jacoco/index.html"

  deploy:
    name: "6. Deploy → EC2"
    needs: [package, integration-tests, coverage]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: artifact
      - name: Deploy
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          echo "$SSH_PRIVATE_KEY" > key.pem && chmod 600 key.pem
          scp -i key.pem -o StrictHostKeyChecking=no artifact/*.jar $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH
          ssh -i key.pem -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST << 'EOF'
            sudo mv ${{ secrets.DEPLOY_PATH }}/*.jar /opt/java/webapps/library-app.jar
            sudo systemctl restart library-app.service
          EOF
